<div class="loading-overlay" *ngIf="isLoading">
  <div class="spinner"></div>
</div>
<div class="transactions-page-container">
  <h2>ðŸ’° {{ 'T.PAGE_HEADER' | translate }}</h2>

  <p-toolbar styleClass="mb-4" style="display:flex; justify-content:space-between">
    <div class="p-toolbar-group-left flex align-items-center">
      <button pButton
              label="{{ 'T.ADD_TRANSACTION_BTN' | translate }}"
              icon="pi pi-plus"
              class="p-button-success mr-2"
              (click)="openCreateModal()"></button>

      <p-fileUpload mode="basic"
                    name="file"
                    chooseLabel="{{ 'T.IMPORT_CSV_BTN' | translate }}"
                    icon="pi pi-upload"
                    accept=".csv"
                    [auto]="false"
                    [maxFileSize]="1000000"
                    (onSelect)="onCsvFileSelect($event)"
                    class="p-button-primary"
                    styleClass="p-button-sm">
      </p-fileUpload>
      
      <button pButton
              label="Export to Excel"
              icon="pi pi-download"
              class="p-button-info ml-2"
              (click)="exportToExcel()"></button>
    </div>
    <div>
      <div class="p-buttonset mr-3">
        <button pButton label="{{ 'T.FILTER_ALL' | translate }}"
                (click)="applyFilter(undefined)"
                [class.p-button-outlined]="currentFilterType !== undefined"
                [class.p-button-secondary]="currentFilterType !== undefined"></button>
        <button pButton label="{{ 'T.FILTER_INCOME' | translate }}"
                (click)="applyFilter('Income')"
                [class.p-button-outlined]="currentFilterType !== 'Income'"
                [class.p-button-secondary]="currentFilterType !== 'Income'"></button>
        <button pButton label="{{ 'T.FILTER_EXPENSE' | translate }}"
                (click)="applyFilter('Expense')"
                [class.p-button-outlined]="currentFilterType !== 'Expense'"
                [class.p-button-secondary]="currentFilterType !== 'Expense'"></button>
      </div>
    </div>
  </p-toolbar>

  <p-table #dt
           [value]="transactions"
           [paginator]="true"
           [rows]="10"
           [showCurrentPageReport]="true"
           currentPageReportTemplate="{{ 'T.PAGINATION_REPORT' | translate }}"
           [rowsPerPageOptions]="[5,10, 25, 50]"
           dataKey="transactionId"
           styleClass="p-datatable-striped"
           [globalFilterFields]="['date', 'type', 'description', 'amount', 'category.name']">

    <ng-template pTemplate="caption">
      <div class="flex">
        <span class="p-input-icon-left ml-auto">
          <i class="pi pi-search"></i>
          <input pInputText type="text"
                 (input)="dt?.filterGlobal($any($event.target).value, 'contains')"
                 placeholder="{{ 'T.GLOBAL_SEARCH_PLACEHOLDER' | translate }}"
                 style="width: 250px" />
        </span>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="date">{{ 'T.TABLE_DATE' | translate }} <p-sortIcon field="date"></p-sortIcon></th>
        <th pSortableColumn="type">{{ 'T.TABLE_TYPE' | translate }} <p-sortIcon field="type"></p-sortIcon></th>
        <th pSortableColumn="description">{{ 'T.TABLE_DESCRIPTION' | translate }} <p-sortIcon field="description"></p-sortIcon></th>
        <th pSortableColumn="categoryId">{{ 'T.TABLE_CATEGORY' | translate }}</th>
        <th pSortableColumn="amount">{{ 'T.TABLE_AMOUNT' | translate }} <p-sortIcon field="amount"></p-sortIcon></th>
        <th style="width: 8rem;">{{ 'T.TABLE_RECURRING' | translate }}</th>
        <th style="width: 8rem;">{{ 'T.TABLE_PHOTO' | translate }}</th>
        <th style="width: 10rem;">{{ 'T.TABLE_ACTIONS' | translate }}</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-transaction>
      <tr>
        <td>{{ transaction.date | date }}</td>
        <td>
          <span [class]="'transaction-type ' + transaction.type.toLowerCase()">
            {{ transaction.type }}
          </span>
        </td>
        <td>{{ transaction.description }}</td>
        <td>
          <span *ngIf="transaction.category">
            {{ transaction.category.name }}
          </span>
          <span *ngIf="!transaction.category" style="color: #ccc; font-style: italic;">
            {{ 'T.UNCATEGORIZED' | translate }}
          </span>
        </td>
        <td>
          <div class="amount-display">
            <span class="converted-amount">{{ transaction | currencyDisplay }}</span>
            <small *ngIf="transaction.amountConverted && transaction.currency !== getCurrentCurrency()" class="original-amount">
              ({{ transaction | currencyDisplay:true }})
            </small>
          </div>
        </td>
        <td class="text-center">
          <i class="pi"
             [ngClass]="{'pi-check-circle text-success': transaction.isRecurring, 'pi-times-circle text-danger': !transaction.isRecurring}"></i>
        </td>
        <td class="text-center">
          <img *ngIf="transaction.photoUrl" [src]="transaction.photoUrl" alt="Receipt" style="max-width: 50px; max-height: 50px; cursor: pointer;" (click)="openPhotoModal(transaction.photoUrl)" />
          <span *ngIf="!transaction.photoUrl">-</span>
        </td>
        <td>
          <button pButton pRipple icon="pi pi-pencil"
                  class="p-button-rounded p-button-success mr-2"
                  (click)="editTransaction(transaction.transactionId)"></button>
          <button pButton pRipple icon="pi pi-trash"
                  class="p-button-rounded p-button-danger"
                  (click)="openDeleteModal(transaction.transactionId)"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="no-data">{{ 'T.NO_TRANSACTIONS' | translate }}</td>
      </tr>
    </ng-template>

  </p-table>
</div>

<p-dialog [header]="isEditMode ? ('T.EDIT_MODAL_HEADER' | translate) : ('T.CREATE_MODAL_HEADER' | translate)"
          [(visible)]="isTransactionModalOpen"
          [modal]="true"
          styleClass="p-fluid"
          [style]="{width: '30rem', maxWidth: '90vw'}"
          (onHide)="closeTransactionModal()">

  <form #transactionForm="ngForm">
    <div class="p-formgrid p-grid">

      <div class="field col-12 md:col-6">
        <label for="type">{{ 'T.FIELD_TYPE' | translate }}*</label>
        <p-dropdown id="type" name="type"
                    [(ngModel)]="selectedTransaction.type"
                    [options]="[{label: 'Income', value: 'Income'}, {label: 'Expense', value: 'Expense'}]"
                    placeholder="{{ 'T.SELECT_TYPE_PLACEHOLDER' | translate }}"
                    required></p-dropdown>
      </div>

      <div class="field col-12 md:col-6">
        <label for="amount">{{ 'T.FIELD_AMOUNT' | translate }}*</label>
        <input id="amount" type="number" pInputText name="amount"
               [(ngModel)]="selectedTransaction.amount" required min="0.01">
      </div>

      <div class="field col-12 md:col-6">
        <label for="currency">{{ 'T.FIELD_CURRENCY' | translate }}*</label>
        <p-dropdown id="currency" name="currency"
                    [(ngModel)]="selectedTransaction.currency"
                    [options]="currencies"
                    placeholder="Select Currency"
                    required></p-dropdown>
      </div>

      <div class="field col-12 md:col-6">
        <label for="date">{{ 'T.FIELD_DATE' | translate }}*</label>
        <p-calendar id="date" name="date"
                    [(ngModel)]="selectedTransaction.date"
                    [showIcon]="true"
                    [dateFormat]="'yy/mm/dd'"
                    required></p-calendar>
      </div>

      <div class="field col-12">
        <label for="description">{{ 'T.FIELD_DESCRIPTION' | translate }}</label>
        <textarea id="description" pInputTextarea name="description"
                  [(ngModel)]="selectedTransaction.description" rows="3"></textarea>
      </div>

      <div class="field col-12">
        <label for="photo">{{ 'T.FIELD_PHOTO' | translate }}</label>
        <div *ngIf="selectedTransaction.photoUrl" class="mb-2">
          <img [src]="selectedTransaction.photoUrl" alt="Current Photo" style="max-width: 100px; max-height: 100px; margin-right: 10px;" />
          <button pButton type="button" label="Remove Photo" icon="pi pi-trash" (click)="removePhoto()" class="p-button-danger p-button-sm"></button>
        </div>
        <input type="file" id="photo" name="photo" accept="image/*"
               (change)="onPhotoSelect($event)" #photoInput>
        <small *ngIf="selectedFile">Selected: {{ selectedFile.name }}</small>
      </div>

      <div class="field col-12 md:col-6">
        <label for="category">{{ 'T.FIELD_CATEGORY' | translate }}</label>
        <p-dropdown id="category" name="categoryId"
                    [(ngModel)]="selectedTransaction.categoryId"
                    [options]="categories"
                    optionLabel="name"
                    optionValue="categoryId"
                    placeholder="{{ 'T.SELECT_CATEGORY_PLACEHOLDER' | translate }}"
                    [appendTo]="'body'"> </p-dropdown>
      </div>

      <div class="field col-12 md:col-6 flex align-items-center" style="padding-top: 30px;">
        <label for="recurring" class="mr-2">{{ 'T.FIELD_RECURRING' | translate }}</label>
        <p-checkbox id="recurring" name="isRecurring"
                    [(ngModel)]="selectedTransaction.isRecurring"
                    [binary]="true"></p-checkbox>
      </div>

    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="{{ 'T.BTN_CANCEL' | translate }}" icon="pi pi-times"
            (click)="closeTransactionModal()"
            class="p-button-text"></button>
    <button pButton type="button" [label]="isEditMode ? ('T.BTN_UPDATE' | translate) : ('T.BTN_SAVE' | translate)" icon="pi pi-check"
            (click)="saveTransaction(transactionForm)"
            [disabled]="!transactionForm.valid || isLoading"
            class="p-button-success"></button>
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="isDeleteModalOpen"
          header="{{ 'T.DELETE_MODAL_HEADER' | translate }}"
          [modal]="true"
          [style]="{width: '450px'}">
  <div class="flex align-items-center">
    <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
    <span>{{ 'T.DELETE_CONFIRM_TEXT' | translate }}</span>
  </div>
  <ng-template pTemplate="footer">
    <button pButton pRipple icon="pi pi-times" class="p-button-text" (click)="closeDeleteModal()" label="{{ 'T.BTN_NO' | translate }}"></button>
    <button pButton pRipple icon="pi pi-check" class="p-button-danger" (click)="confirmDelete()" label="{{ 'T.BTN_YES' | translate }}"></button>
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="isPhotoModalOpen"
          [modal]="true"
          [closable]="false"
          [style]="{width: 'auto', maxWidth: '90vw', maxHeight: '90vh'}">
  <img *ngIf="selectedPhotoUrl" [src]="selectedPhotoUrl" alt="Receipt" style="max-width: 100%; max-height: 100%;" />
  <ng-template pTemplate="footer">
    <button pButton type="button" label="Close" icon="pi pi-times"
            (click)="isPhotoModalOpen = false"
            class="p-button-text"></button>
  </ng-template>
</p-dialog>
