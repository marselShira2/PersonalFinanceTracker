<div class="transactions-page">
  <div class="header-row">
    <h2>üí∞ Transaction History</h2>
    <p-button label="Add New Transaction" icon="pi pi-plus" (click)="openCreateModal()"></p-button>
  </div>

  <hr>

  <div class="filter-controls">
    <button (click)="applyFilter(undefined)"
            [class.active]="currentFilterType === undefined">
      All
    </button>
    <button (click)="applyFilter('Income')"
            [class.active]="currentFilterType === 'Income'">
      Income
    </button>
    <button (click)="applyFilter('Expense')"
            [class.active]="currentFilterType === 'Expense'">
      Expense
    </button>
  </div>

  <p-table #dt
           [value]="transactions" [paginator]="true"
           [rows]="10"
           [showCurrentPageReport]="true"
           currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
           [rowsPerPageOptions]="[5,10, 25, 50]"
           [loading]="isLoading"
           dataKey="transactionId"
           [globalFilterFields]="['date', 'type', 'description', 'amount']">
    <ng-template pTemplate="caption">
      <div class="p-d-flex p-ai-center p-jc-between">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input type="text" pInputText placeholder="Global Search"
                 #filterInput
                 (input)="dt?.filterGlobal(filterInput.value, 'contains')"
                 style="width: 250px">
        </span>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="date">Date <p-sortIcon field="date"></p-sortIcon></th>
        <th pSortableColumn="type">Type <p-sortIcon field="type"></p-sortIcon></th>
        <th pSortableColumn="description">Description <p-sortIcon field="description"></p-sortIcon></th>
        <th pSortableColumn="categoryId">Category</th>
        <th pSortableColumn="amount">Amount <p-sortIcon field="amount"></p-sortIcon></th>
        <th>Recurring</th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-transaction>
      <tr>
        <td>{{ transaction.date | date }}</td>
        <td [class.income]="transaction.type === 'Income'" [class.expense]="transaction.type === 'Expense'">
          {{ transaction.type }}
        </td>
        <td>{{ transaction.description }}</td>
        <td>{{ transaction.categoryId }}</td>
        <td>{{ transaction.amount | currency: transaction.currency : 'symbol' }}</td>
        <td style="text-align: center;">
          <i class="pi" [ngClass]="{'pi-check-circle text-success': transaction.isRecurring, 'pi-times-circle text-danger': !transaction.isRecurring}"></i>
        </td>
        <td>
          <button class="action-btn edit" (click)="editTransaction(transaction.transactionId)">‚úèÔ∏è Modify</button>
          <button class="action-btn delete" (click)="openDeleteModal(transaction.transactionId)">üóëÔ∏è Delete</button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="no-data">No transactions found.</td>
      </tr>
    </ng-template>

  </p-table>
</div>

<div class="modal-overlay" *ngIf="isDeleteModalOpen">
  <div class="modal-content">
    <h3>Confirm Deletion</h3>
    <p>Are you sure you want to delete this transaction?</p>
    <div class="modal-actions">
      <button class="cancel-btn" (click)="closeDeleteModal()">Cancel</button>
      <button class="confirm-btn delete" (click)="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<p-dialog [header]="isEditMode ? 'Edit Transaction' : 'Create New Transaction'"
          [(visible)]="isTransactionModalOpen"
          [modal]="true"
          [style]="{width: '30rem', maxWidth: '90vw'}"
          (onHide)="closeTransactionModal()"
          [draggable]="false"
          [resizable]="false">


  <form (ngSubmit)="saveTransaction(transactionForm)" #transactionForm="ngForm">
    <div class="p-fluid p-formgrid p-grid">

      <div class="p-field p-col-12 p-md-6">
        <label for="type">Type*</label>
        <p-dropdown id="type" name="type"
                    [(ngModel)]="selectedTransaction.type"
                    [options]="[{label: 'Income', value: 'Income'}, {label: 'Expense', value: 'Expense'}]"
                    required></p-dropdown>
      </div>

      <div class="p-field p-col-12 p-md-6">
        <label for="amount">Amount*</label>
        <input id="amount" type="number" pInputText name="amount"
               [(ngModel)]="selectedTransaction.amount" required min="0.01">
      </div>

      <div class="p-field p-col-12 p-md-6">
        <label for="date">Date*</label>
        <p-calendar id="date" name="date"
                    [(ngModel)]="selectedTransaction.date"
                    [showIcon]="true"
                    [dateFormat]="'yy/mm/dd'"
                    required></p-calendar>
      </div>

      <div class="p-field p-col-12 p-md-6">
        <label for="currency">Currency*</label>
        <p-dropdown id="currency" name="currency"
                    [(ngModel)]="selectedTransaction.currency"
                    [options]="currencies"
                    required></p-dropdown>
      </div>

      <div class="p-field p-col-12">
        <label for="description">Description</label>
        <textarea id="description" pInputTextarea name="description"
                  [(ngModel)]="selectedTransaction.description" rows="3"></textarea>
      </div>

      <div class="p-field p-col-12 p-md-6">
        <label for="category">Category</label>
        <p-dropdown id="category" name="categoryId"
                    [(ngModel)]="selectedTransaction.categoryId"
                    [options]="categories"
                    optionLabel="name"
                    optionValue="id"></p-dropdown>
      </div>

      <div class="p-field p-col-12 p-md-6 p-d-flex p-ai-center" style="padding-top: 30px;">
        <label for="recurring" style="margin-right: 10px;">Is Recurring?</label>
        <p-checkbox id="recurring" name="isRecurring"
                    [(ngModel)]="selectedTransaction.isRecurring"
                    [binary]="true"></p-checkbox>
      </div>

    </div>

    <p-footer>
      <button pButton type="button" label="Cancel" icon="pi pi-times"
              (click)="closeTransactionModal()"
              class="p-button-secondary"></button>
      <button pButton type="submit" [label]="isEditMode ? 'Update' : 'Save'" icon="pi pi-check"
              [disabled]="!transactionForm.valid"></button>
    </p-footer>
  </form>
</p-dialog>
