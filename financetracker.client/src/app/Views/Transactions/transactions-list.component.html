<div class="loading-overlay" *ngIf="isLoading">
  <div class="spinner"></div>
</div>
<div class="transactions-page-container">
  <h2>ðŸ’° Transaction History</h2>

  <p-toolbar styleClass="mb-4" style="display:flex; justify-content:space-between">
    <div>
      <button pButton
              label="Add New Transaction"
              icon="pi pi-plus"
              class="p-button-success"
              (click)="openCreateModal()"></button>
    </div>
    <div>
      <div class="p-buttonset mr-3">
        <button pButton
                label="All"
                (click)="applyFilter(undefined)"
                [class.p-button-outlined]="currentFilterType !== undefined"
                [class.p-button-secondary]="currentFilterType !== undefined"></button>
        <button pButton
                label="Income"
                (click)="applyFilter('Income')"
                [class.p-button-outlined]="currentFilterType !== 'Income'"
                [class.p-button-secondary]="currentFilterType !== 'Income'"></button>
        <button pButton
                label="Expense"
                (click)="applyFilter('Expense')"
                [class.p-button-outlined]="currentFilterType !== 'Expense'"
                [class.p-button-secondary]="currentFilterType !== 'Expense'"></button>
      </div>
    </div>
  </p-toolbar>

  <p-table #dt
           [value]="transactions"
           [paginator]="true"
           [rows]="10"
           [showCurrentPageReport]="true"
           currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
           [rowsPerPageOptions]="[5,10, 25, 50]" 
           dataKey="transactionId"
           styleClass="p-datatable-striped"
           [globalFilterFields]="['date', 'type', 'description', 'amount']">

    <ng-template pTemplate="caption">
      <div class="flex">
        <span class="p-input-icon-left ml-auto">
          <i class="pi pi-search"></i>
          <input pInputText type="text"
                 (input)="dt?.filterGlobal($any($event.target).value, 'contains')"
                 placeholder="Global Search"
                 style="width: 250px" />
        </span>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="date">Date <p-sortIcon field="date"></p-sortIcon></th>
        <th pSortableColumn="type">Type <p-sortIcon field="type"></p-sortIcon></th>
        <th pSortableColumn="description">Description <p-sortIcon field="description"></p-sortIcon></th>
        <th pSortableColumn="categoryId">Category</th>
        <th pSortableColumn="amount">Amount <p-sortIcon field="amount"></p-sortIcon></th>
        <th style="width: 8rem;">Recurring</th>
        <th style="width: 10rem;">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-transaction>
      <tr>
        <td>{{ transaction.date | date }}</td>
        <td>
          <span [class]="'transaction-type ' + transaction.type.toLowerCase()">
            {{ transaction.type }}
          </span>
        </td>
        <td>{{ transaction.description }}</td>
        <td>
          <span *ngIf="transaction.category">
            {{ transaction.category.name }}
          </span>
          <span *ngIf="!transaction.category" style="color: #ccc; font-style: italic;">
            Uncategorized
          </span>
        </td>
        <td>{{ transaction.amount | currency: transaction.currency : 'symbol' }}</td>
        <td class="text-center">
          <i class="pi"
             [ngClass]="{'pi-check-circle text-success': transaction.isRecurring, 'pi-times-circle text-danger': !transaction.isRecurring}"></i>
        </td>
        <td>
          <button pButton pRipple icon="pi pi-pencil"
                  class="p-button-rounded p-button-success mr-2"
                  (click)="editTransaction(transaction.transactionId)"></button>
          <button pButton pRipple icon="pi pi-trash"
                  class="p-button-rounded p-button-danger"
                  (click)="openDeleteModal(transaction)"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="no-data">No transactions found.</td>
      </tr>
    </ng-template>

  </p-table>
</div>

<p-dialog [header]="isEditMode ? 'Edit Transaction' : 'Create New Transaction'"
          [(visible)]="isTransactionModalOpen"
          [modal]="true"
          styleClass="p-fluid"
          [style]="{width: '30rem', maxWidth: '90vw'}"
          (onHide)="closeTransactionModal()">

  <form (ngSubmit)="saveTransaction(transactionForm)" #transactionForm="ngForm">
    <div class="p-formgrid p-grid">

      <div class="field col-12 md:col-6">
        <label for="type">Type*</label>
        <p-dropdown id="type" name="type"
                    [(ngModel)]="selectedTransaction.type"
                    [options]="[{label: 'Income', value: 'Income'}, {label: 'Expense', value: 'Expense'}]"
                    placeholder="Select Type"
                    required></p-dropdown>
      </div>

      <div class="field col-12 md:col-6">
        <label for="amount">Amount*</label>
        <input id="amount" type="number" pInputText name="amount"
               [(ngModel)]="selectedTransaction.amount" required min="0.01">
      </div>

      <div class="field col-12 md:col-6">
        <label for="date">Date*</label>
        <p-calendar id="date" name="date"
                    [(ngModel)]="selectedTransaction.date"
                    [showIcon]="true"
                    [dateFormat]="'yy/mm/dd'"
                    required></p-calendar>
      </div>

      <div class="field col-12 md:col-6">
        <label for="currency">Currency*</label>
        <p-dropdown id="currency" name="currency"
                    [(ngModel)]="selectedTransaction.currency"
                    [options]="currencies"
                    placeholder="Select Currency"
                    required></p-dropdown>
      </div>

      <div class="field col-12">
        <label for="description">Description</label>
        <textarea id="description" pInputTextarea name="description"
                  [(ngModel)]="selectedTransaction.description" rows="3"></textarea>
      </div>

      <div class="field col-12 md:col-6">
        <label for="category">Category</label>
        <p-dropdown id="category" name="categoryId"
                    [(ngModel)]="selectedTransaction.categoryId"
                    [options]="categories"
                    optionLabel="name"
                    optionValue="categoryId"
                    placeholder="Select Category"
                    [appendTo]="'body'"> </p-dropdown>
      </div>

      <div class="field col-12 md:col-6 flex align-items-center" style="padding-top: 30px;">
        <label for="recurring" class="mr-2">Is Recurring?</label>
        <p-checkbox id="recurring" name="isRecurring"
                    [(ngModel)]="selectedTransaction.isRecurring"
                    [binary]="true"></p-checkbox>
      </div>

    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cancel" icon="pi pi-times"
            (click)="closeTransactionModal()"
            class="p-button-text"></button>

    <button pButton type="button" [label]="isEditMode ? 'Update' : 'Save'" icon="pi pi-check"
            (click)="saveTransaction(transactionForm)"
            [disabled]="!transactionForm.valid || isLoading"
            class="p-button-success"></button>
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="isDeleteModalOpen"
          header="Confirm Deletion"
          [modal]="true"
          [style]="{width: '450px'}">
  <div class="flex align-items-center">
    <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
    <span>Are you sure you want to delete this transaction?</span>
  </div>
  <ng-template pTemplate="footer">
    <button pButton pRipple icon="pi pi-times" class="p-button-text" (click)="closeDeleteModal()" label="No"></button>
    <button pButton pRipple icon="pi pi-check" class="p-button-danger" (click)="confirmDelete()" label="Yes"></button>
  </ng-template>
</p-dialog>
